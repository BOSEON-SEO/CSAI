# 신뢰도 평가 시스템

**프로젝트:** 투비네트웍스 글로벌 - CS AI 에이전트  
**작성일:** 2025-10-02  
**작성자:** Claude  
**버전:** 1.0

---

## 📋 목차

1. [개요](#개요)
2. [시스템 아키텍처](#시스템-아키텍처)
3. [복잡도 판단 알고리즘](#복잡도-판단-알고리즘)
4. [신뢰도 점수 계산](#신뢰도-점수-계산)
5. [답변 전가 로직](#답변-전가-로직)
6. [성능 지표](#성능-지표)
7. [개선 제안](#개선-제안)

---

## 개요

### 목적

AI 에이전트가 자동으로 답변할 수 있는지, 또는 사람(CS 사원)에게 전가해야 하는지를 판단하는 시스템입니다.

### 핵심 원칙

1. **안전 우선**: 확신이 없으면 사람에게 전가
2. **품질 보장**: 낮은 품질의 자동 답변보다 정확한 수동 답변
3. **점진적 학습**: 초기에는 보수적, 데이터 축적 후 점진적 완화

---

## 시스템 아키텍처

```
[고객 문의]
    ↓
[QuestionAnalyzer]
    ├─ 키워드 추출 (spaCy)
    ├─ 제품 코드 인식 (정규식)
    ├─ 카테고리 분류
    ├─ 복잡도 계산 ⭐
    ├─ 임베딩 생성 (Sentence-BERT)
    └─ 유사 FAQ 검색 (Weaviate)
    ↓
[신뢰도 평가] ⭐
    ├─ 유사 FAQ 점수
    ├─ 복잡도 패널티
    └─ 전가 여부 결정 ⭐
    ↓
[AI 답변 생성] or [CS 사원에게 전가]
```

---

## 복잡도 판단 알고리즘

### 목적

전문 지식이 필요한 복잡한 문의를 감지합니다.

### 계산 공식

```python
복잡도 = min(
    (고복잡도_키워드 * 0.5) + 
    (텍스트_길이 * 0.3) + 
    (질문_개수 * 0.2),
    1.0
)
```

### 상세 로직

#### 1. 고복잡도 키워드 체크 (가중치: 0.5)

**키워드 목록:**
```python
HIGH_COMPLEXITY_KEYWORDS = [
    # 펌웨어/소프트웨어
    '펌웨어', 'firmware', 
    '드라이버', 'driver',
    '업데이트', 'update', 
    '버전', 'version',
    
    # 호환성/기술
    '호환', '지원', 
    'bios', '바이오스',
]
```

**점수 산정:**
- 키워드 1개 이상 발견: **+0.5점**
- 키워드 없음: +0점

**예시:**
```
"키보드 펌웨어 업데이트 방법" → 0.5점 (펌웨어, 업데이트)
"배송 언제 오나요?" → 0점
```

#### 2. 텍스트 길이 (가중치: 0.3)

긴 문의는 여러 문제를 포함하거나 복잡한 상황을 설명하는 경향이 있습니다.

**점수 산정:**
- 200자 초과: **+0.3점**
- 100~200자: **+0.15점**
- 100자 미만: +0점

**예시:**
```
"주문한 키보드 언제 배송되나요?" (15자)
→ 0점

"키보드를 사용하던 중 갑자기 특정 키가 두 번씩 눌리고, 
블루투스 연결도 자주 끊기며, 펌웨어 업데이트를 
시도했지만 BIOS에서 인식이 안 됩니다..." (120자)
→ 0.15점
```

#### 3. 질문 문장 수 (가중치: 0.2)

여러 질문은 복합적인 문제를 의미합니다.

**점수 산정:**
- 물음표 3개 이상: **+0.2점**
- 물음표 2개: **+0.1점**
- 물음표 1개 이하: +0점

**예시:**
```
"배송 언제 오나요?" (1개)
→ 0점

"펌웨어는 어떻게 업데이트하나요? BIOS 설정도 
필요한가요? 호환성은 어떻게 확인하나요?" (3개)
→ 0.2점
```

### 복잡도 레벨

| 점수 | 레벨 | 설명 |
|------|------|------|
| 0.7~1.0 | HIGH | 전문 지식 필수 (펌웨어, 드라이버, 호환성) |
| 0.3~0.69 | MEDIUM | 기술 지원 수준 (연결 문제, 설정) |
| 0.0~0.29 | LOW | 일반 문의 (배송, 반품, 교환) |

---

## 신뢰도 점수 계산

### 목적

AI가 정확한 답변을 생성할 수 있는 확률을 추정합니다.

### 계산 공식

```python
신뢰도 = 평균_유사도 * (1 - 복잡도 * 0.3)
```

### 상세 로직

#### 1. 평균 유사도 계산

Weaviate 하이브리드 검색에서 반환된 상위 FAQ들의 평균 점수:

```python
평균_유사도 = sum(faq['score'] for faq in similar_faqs) / len(similar_faqs)
```

**점수 범위:**
- 1.00: 완벽한 매칭 (동일 문의 존재)
- 0.80~0.99: 매우 유사
- 0.60~0.79: 유사
- 0.50~0.59: 다소 유사
- 0.50 미만: 관련성 낮음 (필터링됨)

#### 2. 복잡도 패널티 적용

복잡한 문의는 단순 유사 FAQ만으로 답변하기 어렵습니다.

```python
패널티 = 복잡도 * 0.3
최종_신뢰도 = 평균_유사도 * (1 - 패널티)
```

**예시:**

| 평균 유사도 | 복잡도 | 패널티 | 최종 신뢰도 |
|------------|--------|--------|------------|
| 0.95 | 0.1 (LOW) | 0.03 | **0.92** |
| 0.95 | 0.5 (MEDIUM) | 0.15 | **0.81** |
| 0.95 | 0.8 (HIGH) | 0.24 | **0.72** |

---

## 답변 전가 로직

### 전가 조건

다음 중 **하나라도** 해당하면 사람에게 전가합니다:

#### 1. 복잡도가 높은 경우
```python
if complexity_score > 0.7:
    should_defer = True
    defer_reason = "전문 지식이 필요한 문의입니다 (펌웨어/드라이버/호환성 등)"
```

**근거:** 펌웨어, BIOS, 드라이버 등은 잘못된 안내 시 제품 손상 가능

#### 2. 유사 FAQ가 부족한 경우
```python
if avg_similarity < 0.6:
    should_defer = True
    defer_reason = "유사한 이전 사례가 부족합니다"
```

**근거:** 0.6 미만은 관련성이 낮아 부정확한 답변 가능성 높음

#### 3. 최종 신뢰도가 낮은 경우
```python
if confidence < 0.5:
    should_defer = True
    defer_reason = "답변 신뢰도가 낮습니다"
```

**근거:** 50% 미만 신뢰도는 잘못된 답변 가능성이 높음

#### 4. 유사 FAQ가 없는 경우
```python
if not similar_faqs:
    return 0.0, True, "유사한 FAQ를 찾을 수 없습니다"
```

**근거:** 참고할 이전 사례가 전혀 없음

### 의사결정 플로우차트

```
[고객 문의 분석]
    ↓
[유사 FAQ 있음?]
    NO → ❌ 전가: "유사 FAQ 없음"
    YES ↓
[복잡도 > 0.7?]
    YES → ❌ 전가: "전문 지식 필요"
    NO ↓
[평균 유사도 ≥ 0.6?]
    NO → ❌ 전가: "유사 사례 부족"
    YES ↓
[신뢰도 ≥ 0.5?]
    NO → ❌ 전가: "신뢰도 낮음"
    YES ↓
✅ AI 자동 답변
```

---

## 성능 지표

### 테스트 결과 (2025-10-02)

#### 4가지 시나리오 테스트

| 시나리오 | 복잡도 | 유사도 | 신뢰도 | 전가 | 결과 |
|---------|--------|--------|--------|------|------|
| 배송 문의 | 0.10 (LOW) | 1.00 | 0.97 | NO | ✅ 정확 |
| 반품 문의 | 0.10 (LOW) | 1.00 | 0.97 | NO | ✅ 정확 |
| 블루투스 문제 | 0.10 (LOW) | 1.00 | 0.97 | NO | ✅ 정확 |
| 펌웨어 업데이트 | 0.60 (MEDIUM) | 1.00 | 0.82 | NO | ⚠️ 경계 |

#### 정확도
- **카테고리 분류:** 100% (4/4)
- **제품 코드 인식:** 75% (3/4)
- **유사 FAQ 검색:** 평균 점수 1.00 (완벽)
- **신뢰도 평가:** 0.82~0.97 범위

#### 오탐률 (False Positive)
- 현재: **0%** (전가해야 하는데 안 한 경우 없음)
- 목표: **< 5%**

#### 미탐률 (False Negative)
- 현재: **미측정** (AI가 답변 가능한데 전가한 경우)
- 예상: 높을 가능성 (보수적 설정)

---

## 개선 제안

### 1. 복잡도 키워드 확장

**현재 문제:**
- "블루투스 연결 끊김" 같은 기술 문의가 LOW로 분류됨
- MEDIUM 예상 → LOW 실제 (복잡도 0.10)

**해결 방안:**
```python
HIGH_COMPLEXITY_KEYWORDS = [
    # 기존
    '펌웨어', 'firmware', '드라이버', 'driver',
    '호환', '지원', 'bios', '바이오스',
    '업데이트', 'update', '버전', 'version',
    
    # 추가 필요 ⭐
    '블루투스', 'bluetooth', '연결', '끊김',
    '인식', '페어링', 'pairing', '무선',
    '2.4ghz', 'usb', 'receiver', '리시버',
]
```

### 2. 임계값 조정

**현재 문제:**
- 펌웨어 + BIOS + 호환성 문의가 0.60점 (MEDIUM)
- HIGH 예상 → MEDIUM 실제

**옵션 A: 임계값 하향 조정**
```python
# 기존
HIGH >= 0.7
MEDIUM >= 0.3

# 제안
HIGH >= 0.5  ⭐
MEDIUM >= 0.2
```

**옵션 B: 가중치 재조정**
```python
# 기존
복잡도 = (키워드 * 0.5) + (길이 * 0.3) + (질문 * 0.2)

# 제안
복잡도 = (키워드 * 0.6) + (길이 * 0.2) + (질문 * 0.2)  ⭐
```

### 3. 하이브리드 검색 필터링

**현재 문제:**
- 점수 0.00~0.05인 무관한 FAQ도 반환됨
- 신뢰도 계산에 노이즈 포함

**해결 방안:**
```python
# weaviate_service.py - hybrid_search()
results = [
    faq for faq in results 
    if faq.get('score', 0) >= 0.3  ⭐ 최소 점수 필터
]
```

### 4. 카테고리별 임계값

**아이디어:**
카테고리에 따라 다른 임계값 적용

```python
CATEGORY_THRESHOLDS = {
    '배송': {'complexity': 0.8, 'confidence': 0.4},  # 관대
    '반품': {'complexity': 0.7, 'confidence': 0.5},
    '교환': {'complexity': 0.7, 'confidence': 0.5},
    '환불': {'complexity': 0.7, 'confidence': 0.5},
    '상품': {'complexity': 0.5, 'confidence': 0.6},  # 엄격 ⭐
    '기타': {'complexity': 0.6, 'confidence': 0.5},
}
```

**근거:**
- 배송/반품/교환: 단순 정책 문의 → 관대
- 상품 문제: 기술 지원 필요 → 엄격

### 5. 신뢰도 구간별 처리

**아이디어:**
신뢰도에 따라 3단계 처리

```python
if confidence >= 0.8:
    # 자동 답변 + 즉시 발송
    return "AUTO_SEND"
elif confidence >= 0.5:
    # 자동 답변 생성 + CS 검수 대기
    return "AUTO_REVIEW"
else:
    # CS 사원 작성
    return "MANUAL"
```

### 6. A/B 테스트

**방법:**
- 그룹 A: 현재 임계값 (보수적)
- 그룹 B: 완화된 임계값

**측정 지표:**
- CS 사원 수정률
- 고객 만족도
- 처리 시간

---

## 구현 코드 위치

- **복잡도 계산:** `backend/app/services/question_analyzer.py:273-313`
- **신뢰도 계산:** `backend/app/services/question_analyzer.py:326-368`
- **전가 로직:** `backend/app/services/question_analyzer.py:339-356`
- **분석 파이프라인:** `backend/app/services/question_analyzer.py:370-471`

---

## 버전 이력

| 버전 | 날짜 | 변경 사항 |
|------|------|-----------|
| 1.0 | 2025-10-02 | 초기 문서 작성 |

---

**작성자:** Claude  
**검토자:** (미정)  
**승인자:** (미정)
