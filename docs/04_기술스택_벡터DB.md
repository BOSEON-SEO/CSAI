# 04. 기술 스택 - 벡터 데이터베이스 (Weaviate)

**작성일**: 2025-09-30  
**최종 업데이트**: 2025-10-02 10:00, Claude 업데이트  
**Phase**: Phase 0 설계 완료, Phase 2 준비 완료

---

## 📋 목차

1. [개요](#개요)
2. [선정 이유](#선정-이유)
3. [Weaviate 특징](#weaviate-특징)
4. [아키텍처](#아키텍처)
5. [구현 상태](#구현-상태)
6. [다음 단계](#다음-단계)

---

## 개요

### Weaviate란?

**Weaviate**는 오픈소스 벡터 데이터베이스로, AI 애플리케이션을 위한 의미 검색(Semantic Search)을 제공합니다.

**공식 사이트**: https://weaviate.io/

### 프로젝트에서의 역할

```
고객 질문 "키크론 K10 PRO MAX 블루투스 안되는데요"
         ↓
   [Sentence-BERT로 벡터화]
         ↓
   [Weaviate에서 유사 FAQ 검색]
         ↓
유사한 FAQ ID 반환: [123, 456, 789]
         ↓
   [MongoDB에서 실제 FAQ 내용 조회]
```

**핵심**: Weaviate는 "도서관 사서" 역할 → 비슷한 내용의 책(FAQ) 빠르게 찾아줌

---

## 선정 이유

### 후보 벡터 DB 비교표

| DB | 하이브리드 검색 | 멀티모달 | 설정 난이도 | 비용 | 추천 규모 | 선정 |
|----|----------------|----------|-------------|------|-----------|------|
| **Weaviate** | ✅ 내장 | ✅ | 중간 | 무료 | 1K~10M | ✅ |
| Milvus | ❌ | ✅ | 어려움 | 무료 | 100K~1B+ | ❌ |
| Qdrant | ❌ | ❌ | 쉬움 | 무료 | 1K~1M | ❌ |
| OpenSearch | ✅ 기본 | ❌ | 어려움 | 무료 | 10K~100M | ❌ |
| MongoDB Vector | ✅ 기본 | ❌ | 쉬움 | 유료 | 1K~100K | ❌ |

### 1. 하이브리드 검색 필수 ✨

**시나리오**:
```
질문: "KB-TKL-001 펌웨어 v2.3 버그 있나요?"

의미 검색만 사용:
  → "키보드 문제", "펌웨어 업데이트" (일반적, 부정확)

하이브리드 검색 (Weaviate):
  → 정확한 모델명 (KB-TKL-001) 필터링
  → 버전 (v2.3) 필터링
  → 의미 유사도 (버그, 문제)
  → 훨씬 정확한 결과! ✅
```

**장점**:
- 제품 코드, 버전 번호 같은 정확한 키워드 매칭
- 동시에 의미적 유사도도 고려
- 검색 정확도 대폭 향상

### 2. 멀티모달 지원 (미래 확장성)

**현재**: 텍스트 검색만 사용  
**미래 확장**:
```python
# 고객이 제품 이미지 첨부
# "이 키보드 어떤 제품인가요?"

weaviate.search(
    text="키보드",
    image=customer_photo,  # ← 이미지 기반 검색!
    limit=5
)
# → 사진과 유사한 제품 자동 식별
```

**활용 사례**:
- 제품 이미지 기반 문의 대응
- 비교 문의 (2개 이미지 첨부 가능)
- AR/VR 확장 시 3D 모델 검색

### 3. MongoDB와의 완벽한 협업

```
Weaviate (책 찾는 사서)          MongoDB (실제 책장)
    ↓                                ↓
벡터 유사도 계산                  실제 데이터 저장
FAQ ID 반환                       FAQ 전체 내용 반환
    ↓                                ↓
        함께 사용하여 완벽한 검색 시스템 구축
```

**역할 분담**:
- **Weaviate**: "어떤 FAQ가 유사한가?" (의미 검색)
- **MongoDB**: "그 FAQ의 실제 내용은?" (데이터 저장)

### 4. 비용 효율성

```
월별 운영 비용 (900건 기준):
  Weaviate (셀프호스팅)    $0
  MongoDB (셀프호스팅)     $0
  Claude API              $45
  ────────────────────────────
  총 비용                 $45/월
```

**개발 환경**:
- Docker Desktop에서 무료 실행
- Windows PC에서 모든 서비스 로컬 운영
- 추가 클라우드 비용 없음

---

## Weaviate 특징

### 1. 하이브리드 검색 (BM25 + Vector)

**BM25**: 키워드 기반 검색 (전통적)  
**Vector**: 의미 기반 검색 (AI)

```python
# Weaviate 하이브리드 검색 예시
collection.query.hybrid(
    query="키크론 블루투스 연결 안됨",
    alpha=0.5,  # 0.0 = BM25만, 1.0 = Vector만, 0.5 = 균형
    properties=["title", "content"],
    limit=5
)
```

**Alpha 값에 따른 동작**:
- `alpha=0.0`: 키워드 정확 매칭 (BM25)
- `alpha=0.5`: 키워드 + 의미 균형 (추천)
- `alpha=1.0`: 의미만 (Vector)

### 2. 필터링

```python
# 제품명으로 필터링
collection.query.hybrid(
    query="연결 안됨",
    filters=Filter.by_property("product_name").contains_any(["K10", "K8"])
)

# 브랜드 + 카테고리 필터
collection.query.hybrid(
    query="블루투스 문제",
    filters=(
        Filter.by_property("brand").equal("KEYCHRON") &
        Filter.by_property("category").equal("기술지원")
    )
)
```

### 3. 멀티테넌시 (브랜드별 격리)

```python
# 키크론만 검색
collection.query.hybrid(
    query="...",
    tenant="KEYCHRON"
)

# 지티기어만 검색
collection.query.hybrid(
    query="...",
    tenant="GTGEAR"
)
```

**장점**:
- 브랜드별 데이터 격리
- 보안 및 성능 향상
- 확장성 (신규 브랜드 추가 용이)

### 4. 스케일링

```
1K FAQs    → 검색 시간: ~10ms
10K FAQs   → 검색 시간: ~20ms
100K FAQs  → 검색 시간: ~50ms
1M FAQs    → 검색 시간: ~200ms
```

**우리 프로젝트 예상**:
- 초기: 500 FAQs → ~10ms
- 1년 후: 5,000 FAQs → ~20ms
- 여유 있음 ✅

---

## 아키텍처

### 시스템 구성

```
┌─────────────────────────────────────────────┐
│         고객 질문 입력                        │
│   "K10 PRO MAX 블루투스 안돼요"              │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│      Sentence-BERT (QuestionAnalyzer)       │
│   텍스트 → 768차원 벡터로 변환               │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│          Weaviate (Vector Search)           │
│   • 하이브리드 검색 (BM25 + Vector)          │
│   • 필터: brand=KEYCHRON, category=기술     │
│   • 유사도 Top 5 반환                        │
└─────────────────┬───────────────────────────┘
                  ↓
         [FAQ IDs: 123, 456, 789]
                  ↓
┌─────────────────────────────────────────────┐
│            MongoDB (Data Store)             │
│   FAQ ID로 실제 FAQ 내용 조회                │
│   + 고객 정보 + 제품 스펙                     │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│        Claude API (Answer Generator)        │
│   유사 FAQ + 제품 정보 → 답변 생성           │
└─────────────────────────────────────────────┘
```

### Weaviate 스키마 설계

#### FAQ 컬렉션

```python
{
    "class": "FAQ",
    "description": "고객 문의 FAQ 벡터 저장소",
    
    "properties": [
        {
            "name": "faq_id",
            "dataType": ["text"],
            "description": "FAQ 고유 ID (MongoDB _id 매핑)"
        },
        {
            "name": "inquiry_no",
            "dataType": ["text"],
            "description": "네이버 문의 번호"
        },
        {
            "name": "brand_channel",
            "dataType": ["text"],
            "description": "브랜드 (KEYCHRON, GTGEAR, AIPER)"
        },
        {
            "name": "category",
            "dataType": ["text"],
            "description": "카테고리 (상품, 배송, 기술, 반품, 기타)"
        },
        {
            "name": "combined_text",
            "dataType": ["text"],
            "description": "제목 + 질문 + 답변 결합 텍스트"
        },
        {
            "name": "answered",
            "dataType": ["boolean"],
            "description": "답변 완료 여부"
        },
        {
            "name": "created_at",
            "dataType": ["date"],
            "description": "생성 일시"
        }
    ],
    
    "vectorizer": "none",  # Sentence-BERT로 직접 생성
    "vectorIndexType": "hnsw",
    "vectorIndexConfig": {
        "distance": "cosine",  # 코사인 유사도
        "ef": 100,
        "efConstruction": 128,
        "maxConnections": 64
    }
}
```

**HNSW 인덱스 설정**:
- `ef`: 검색 정확도 (높을수록 정확, 느림)
- `efConstruction`: 인덱스 구축 시 정확도
- `maxConnections`: 노드당 최대 연결 (메모리 vs 속도)

---

## 구현 상태

### ✅ Phase 1: 인프라 구축 완료 (2025-10-01)

```bash
# Docker Compose로 Weaviate 실행
docker-compose up -d weaviate

# 서비스 확인
curl http://localhost:8081/v1/meta
# → {"version": "1.25.5"} 정상 응답
```

**설치된 서비스**:
- Weaviate v1.25.5
- 포트: 8081 (Spring Boot와 충돌 방지)
- CUDA 지원 활성화

### ✅ Phase 2: 스키마 설계 완료 (2025-10-01)

```python
# backend/scripts/setup_weaviate.py 작성 완료
# FAQ 컬렉션 스키마 정의
# 인덱스 설정 최적화
```

### 🔄 Phase 3: 임베딩 생성 및 업로드 (진행 중)

**현재 작업**:
```python
# backend/scripts/import_to_weaviate.py (작성 중)

# 1. MongoDB에서 FAQ 읽기
faqs = mongodb.faqs.find({"brand_channel": "KEYCHRON"})

# 2. Sentence-BERT로 임베딩 생성
embeddings = sentence_bert.encode(faq_texts)

# 3. Weaviate에 벡터 + 메타데이터 저장
weaviate.batch.add_objects(
    objects=[
        {
            "faq_id": faq["_id"],
            "combined_text": faq["title"] + " " + faq["content"],
            "brand_channel": faq["brand_channel"],
            ...
        }
        for faq in faqs
    ],
    vectors=embeddings
)
```

**예정 작업** (Phase 3):
- [ ] MongoDB FAQ 100건 임베딩 생성
- [ ] Weaviate 업로드 및 인덱싱
- [ ] 검색 테스트 (하이브리드, 필터)
- [ ] 성능 측정 (응답 시간, 정확도)

---

## 다음 단계

### Phase 3 작업 계획 (2025-10-02 ~ 11-03)

#### 1주차: 임베딩 생성 및 업로드
```bash
# 스크립트 실행
cd backend/scripts
python import_to_weaviate.py --type faqs --brand KEYCHRON

# 예상 결과:
# - 100건 FAQ 임베딩 생성 (Sentence-BERT)
# - Weaviate 업로드 완료
# - 인덱스 구축 완료
```

#### 2주차: WeaviateService 구현
```python
# backend/app/services/weaviate_service.py

class WeaviateService:
    async def search_similar_faqs(
        self,
        query: str,
        brand: str,
        category: Optional[str] = None,
        limit: int = 5
    ) -> List[Dict]:
        """
        유사 FAQ 검색
        
        Args:
            query: 고객 질문
            brand: 브랜드 (KEYCHRON, GTGEAR 등)
            category: 카테고리 필터 (선택)
            limit: 반환 개수
        
        Returns:
            유사 FAQ 목록 (ID + 유사도 점수)
        """
        # 임베딩 생성
        embedding = self.embedding_model.encode(query)
        
        # Weaviate 하이브리드 검색
        results = self.collection.query.hybrid(
            query=query,
            vector=embedding,
            alpha=0.5,
            filters=self._build_filters(brand, category),
            limit=limit
        )
        
        return results
```

#### 3~4주차: 통합 및 테스트
- [ ] FastAPI 엔드포인트 연동
- [ ] 검색 성능 최적화
- [ ] Alpha 값 튜닝 (키워드 vs 의미 비율)
- [ ] 캐싱 적용 (Redis)

---

## 참고 자료

### 공식 문서
- Weaviate 공식 사이트: https://weaviate.io/
- Python 클라이언트: https://weaviate.io/developers/weaviate/client-libraries/python
- 하이브리드 검색: https://weaviate.io/developers/weaviate/search/hybrid

### 프로젝트 관련 문서
- [02. 시스템 아키텍처](./02_시스템_아키텍처.md)
- [03. 질문 분석 (Sentence-BERT)](./03_기술스택_질문분석.md)
- [05. NoSQL (MongoDB)](./05_기술스택_NoSQL.md)
- [개발 계획](./09_개발_계획.md)

---

**문서 작성**: 2025-09-30, Claude  
**최종 업데이트**: 2025-10-02 10:00, Claude  
**다음 업데이트**: Phase 3 임베딩 업로드 완료 시
