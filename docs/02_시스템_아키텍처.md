# 02. 시스템 아키텍처

## 전체 워크플로우

### 고수준 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                    외부 시스템                           │
│  (네이버 스마트스토어, 자사 어드민 시스템)                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
         ┌───────────────────────┐
         │   스케줄러 (Cron)      │
         │   - 매 30분마다 실행   │
         └───────────┬───────────┘
                     │
                     ↓
         ┌───────────────────────┐
         │  미응답 FAQ 수집 API   │
         │  - 질문 목록 조회      │
         │  - 고객 정보 조회      │
         └───────────┬───────────┘
                     │
                     ↓
    ┌────────────────────────────────────┐
    │      AI 에이전트 코어 (FastAPI)     │ ← 이 프로젝트의 핵심
    │  ┌──────────────────────────────┐  │
    │  │  1. 질문 분석 & 분류          │  │
    │  │  2. 컨텍스트 수집             │  │
    │  │  3. RAG 검색                 │  │
    │  │  4. 신뢰도 평가               │  │
    │  │  5. 답변 생성                │  │
    │  └──────────────────────────────┘  │
    └────────────┬───────────────────────┘
                 │
                 ↓
     ┌───────────────────────┐
     │   CS 검수 UI (Next.js) │
     │   - 답변 검토          │
     │   - 승인/수정/거부     │
     └───────────┬───────────┘
                 │
                 ↓
     ┌───────────────────────┐
     │  판매 채널 등록 API     │
     │  - FAQ 답변 등록       │
     └───────────────────────┘
```

---

## AI 에이전트 코어 상세 아키텍처

### 처리 흐름

```
[질문 입력]
    ↓
┌─────────────────────────────────┐
│ 1. 질문 분석 & 분류              │
│    (Sentence-BERT + spaCy)      │
│                                 │
│ 출력:                           │
│ - category: "기술지원"          │
│ - keywords: [블루투스, 연결]    │
│ - product_codes: [KB-001]      │
│ - complexity: "medium"         │
│ - tech_terms_count: 2          │
│                                 │
│ 처리 시간: 15-20ms              │
└──────────┬──────────────────────┘
           ↓
┌─────────────────────────────────┐
│ 2. 컨텍스트 수집                 │
│    (MongoDB API 호출)           │
│                                 │
│ 조회:                           │
│ - 고객 정보 (이름, 연락처)       │
│ - 주문 이력 (구매 제품)          │
│ - 과거 문의 이력                 │
│                                 │
│ 처리 시간: 10-15ms              │
└──────────┬──────────────────────┘
           ↓
┌─────────────────────────────────┐
│ 3. RAG 검색                     │
│                                 │
│ 3-1. Weaviate 검색 (50ms)      │
│      - 유사 FAQ 검색            │
│      - 하이브리드 검색 사용      │
│      - Top 5 결과 반환          │
│                                 │
│ 3-2. MongoDB 조회 (10ms)       │
│      - FAQ 원문 가져오기        │
│      - 제품 스펙 조회            │
│                                 │
│ 처리 시간: 60ms                │
└──────────┬──────────────────────┘
           ↓
┌─────────────────────────────────┐
│ 4. 신뢰도 평가                   │
│                                 │
│ 평가 항목:                      │
│ - 검색 결과 유사도 (30점)        │
│ - 제품 스펙 최신성 (20점)        │
│ - 기술 용어 포함 (-25점)        │
│ - 과거 성공률 (20점)            │
│ - 고객-제품 매칭 (10점)         │
│                                 │
│ 결과:                           │
│ - 70+ : 자동 생성 가능          │
│ - 50-69 : 검토 필요             │
│ - 50- : 사람 처리 필요          │
│                                 │
│ 처리 시간: 5ms                  │
└──────────┬──────────────────────┘
           │
           ├─ [신뢰도 낮음] → "CS 검토 필요" 플래그
           │                  (사람에게 직접 전달)
           │
           └─ [신뢰도 높음]
                    ↓
         ┌─────────────────────────┐
         │ 5. Claude 답변 생성      │
         │    (MCP 활용)           │
         │                         │
         │ 입력:                   │
         │ - 질문 분석 결과        │
         │ - 유사 FAQ 5개          │
         │ - 제품 스펙             │
         │ - 고객 정보             │
         │                         │
         │ 출력:                   │
         │ - answer (답변 텍스트)  │
         │ - confidence (0-100)   │
         │ - sources (출처 목록)   │
         │ - requires_review      │
         │                         │
         │ 처리 시간: 2000-3000ms  │
         └──────────┬──────────────┘
                    ↓
         ┌─────────────────────────┐
         │ 답변 + 메타데이터 반환   │
         │                         │
         │ {                       │
         │   "answer": "...",      │
         │   "category": "...",    │
         │   "confidence": 85,     │
         │   "sources": [...],     │
         │   "requires_review": false │
         │ }                       │
         └─────────────────────────┘
```

### 총 처리 시간
```
질문 분석:        20ms  (1%)
컨텍스트 수집:    15ms  (0.7%)
RAG 검색:         60ms  (2.8%)
신뢰도 평가:       5ms  (0.2%)
답변 생성:      2500ms (95.3%)
─────────────────────────────
합계:           2600ms (100%)
```

**병목 지점**: Claude API (95% 시간 소요)

---

## 데이터 흐름도

### 데이터베이스 구성

```
┌──────────────────────────────────────────────────┐
│                   Weaviate                       │
│           (벡터 데이터베이스)                     │
│                                                  │
│  Collection: FAQ                                 │
│  ├─ Vector: [0.23, -0.45, 0.67, ...]           │
│  ├─ Metadata:                                    │
│  │   ├─ faq_id: "FAQ-123"                      │
│  │   ├─ category: "기술지원"                   │
│  │   └─ product_category: "keyboard"           │
│  └─ 인덱스: HNSW                                │
│                                                  │
│  총 데이터: 1,000~10,000 벡터 (예상)            │
└──────────────────────────────────────────────────┘
           ↕ (임베딩 ↔ ID 매핑)
┌──────────────────────────────────────────────────┐
│                   MongoDB                        │
│           (NoSQL 데이터베이스)                    │
│                                                  │
│  Collection: faqs                                │
│  ├─ _id: ObjectId                               │
│  ├─ faq_id: "FAQ-123"                          │
│  ├─ question: "키보드 블루투스 연결 방법"        │
│  ├─ answer: "설정 → 블루투스 → 페어링"          │
│  ├─ category: "기술지원"                        │
│  └─ created_at: ISODate                         │
│                                                  │
│  Collection: products                            │
│  ├─ product_id: "KB-001"                        │
│  ├─ name: "무선 키보드"                         │
│  ├─ specs: { ... } (가변 스키마)                │
│  └─ updated_at: ISODate                         │
│                                                  │
│  Collection: customers                           │
│  ├─ customer_id: "CUST-123"                     │
│  ├─ name: "김철수"                              │
│  ├─ orders: [...]                               │
│  └─ inquiry_history: [...]                      │
│                                                  │
│  Collection: logs (분석용)                       │
│  ├─ question_id                                 │
│  ├─ processing_steps                            │
│  ├─ confidence_scores                           │
│  └─ cs_actions                                  │
└──────────────────────────────────────────────────┘
```

### 데이터 동기화

```
[제품 스펙 업데이트]
    ↓
MongoDB 업데이트
    ↓
임베딩 재생성 (Sentence-BERT)
    ↓
Weaviate 벡터 업데이트
    ↓
완료 (실시간 반영)
```

---

## 컴포넌트 구성

### 백엔드 (FastAPI)

```
/backend
├── main.py                    # FastAPI 앱 진입점
├── /services
│   ├── question_analyzer.py   # Sentence-BERT + spaCy
│   ├── weaviate_service.py    # Weaviate 검색
│   ├── mongodb_service.py     # MongoDB 조회
│   ├── claude_service.py      # Claude API 호출
│   └── confidence_scorer.py   # 신뢰도 평가
├── /models
│   ├── question.py            # 질문 데이터 모델
│   ├── answer.py              # 답변 데이터 모델
│   └── confidence.py          # 신뢰도 모델
├── /routers
│   ├── analyze.py             # POST /api/analyze
│   ├── search.py              # POST /api/search
│   └── generate.py            # POST /api/generate
└── /utils
    ├── embedding.py           # 임베딩 유틸
    └── logger.py              # 로깅 설정
```

### 프론트엔드 (Next.js)

```
/frontend
├── /app
│   ├── page.tsx               # 메인 대시보드
│   ├── /review
│   │   └── page.tsx           # 검수 대기열
│   └── /review/[id]
│       └── page.tsx           # 검수 상세
├── /components
│   ├── ReviewQueue.tsx        # 대기열 목록
│   ├── ReviewDetail.tsx       # 답변 상세 보기
│   ├── AnswerEditor.tsx       # 답변 수정
│   └── ApprovalButtons.tsx    # 승인/거부 버튼
├── /hooks
│   ├── useSSE.ts              # Server-Sent Events
│   └── useAnswers.ts          # 답변 데이터 관리
└── /lib
    ├── api.ts                 # API 클라이언트
    └── utils.ts               # 유틸 함수
```

---

## MCP 서버 구성

Claude MCP(Model Context Protocol)를 통해 다양한 도구에 접근합니다.

```
Claude API
    ↓
MCP Protocol
    ↓
┌──────────────────────┐
│   MCP 서버들         │
├──────────────────────┤
│                      │
│ 1. weaviate-server   │ ← Weaviate 검색
│    - 유사 FAQ 검색   │
│    - 하이브리드 검색 │
│                      │
│ 2. mongodb-server    │ ← MongoDB 조회
│    - 제품 스펙 조회  │
│    - 고객 정보 조회  │
│                      │
│ 3. customer-api      │ ← 외부 API
│    - 주문 이력 조회  │
│    - 배송 정보 조회  │
│                      │
│ 4. approval-queue    │ ← 검수 시스템
│    - 대기열 관리     │
│    - 상태 업데이트   │
│                      │
└──────────────────────┘
```

---

## 인프라 구성

### 개발 환경 (Windows)

```
개발 PC
├── Python 3.11+ (FastAPI, ML 모델)
├── Node.js 20+ (Next.js)
├── Docker Desktop
│   ├── Weaviate Container
│   ├── MongoDB Container
│   └── Redis Container (캐싱용)
└── GPU: RTX 3050 (Sentence-BERT 가속)
```

### 배포 환경 (Linux 서버)

```
Linux Server (Ubuntu 22.04)
├── Docker Compose
│   ├── FastAPI (API 서버)
│   ├── Next.js (프론트엔드)
│   ├── Weaviate (벡터 DB)
│   ├── MongoDB (NoSQL)
│   ├── Redis (캐시)
│   └── Nginx (리버스 프록시)
├── 리소스 요구사항:
│   ├── CPU: 4+ cores
│   ├── RAM: 16GB+
│   ├── Storage: 100GB SSD
│   └── GPU: 선택 (있으면 6배 빠름)
└── 네트워크:
    ├── 포트 80/443: Nginx
    ├── 포트 8000: FastAPI
    ├── 포트 3000: Next.js (내부)
    ├── 포트 8080: Weaviate (내부)
    └── 포트 27017: MongoDB (내부)
```

---

## 보안 아키텍처

### 인증/인가

```
CS 사원 로그인
    ↓
JWT 토큰 발급
    ↓
모든 API 요청에 토큰 포함
    ↓
FastAPI 미들웨어에서 검증
    ↓
권한에 따라 접근 허용/거부
```

### 데이터 암호화

- **전송 중**: HTTPS (TLS 1.3)
- **저장 중**: MongoDB Encryption at Rest
- **API 키**: 환경 변수로 관리, 절대 코드에 하드코딩 금지

### 접근 제어

| 역할 | 권한 |
|------|------|
| CS 사원 | 답변 검수, 승인/수정/거부 |
| 관리자 | 전체 시스템 설정, 데이터 관리 |
| AI 에이전트 | 읽기 전용 (DB 조회만) |

---

## 모니터링 & 로깅

### 실시간 모니터링

```
Grafana Dashboard
├── API 응답 시간
├── 처리 건수 (시간대별)
├── 신뢰도 점수 분포
├── CS 승인/거부율
└── 에러 발생 빈도
```

### 로그 수집

```
모든 처리 단계를 MongoDB에 로깅:

{
  "timestamp": "2025-09-30T14:32:00Z",
  "question_id": "FAQ-001",
  "steps": [
    {"name": "analyze", "duration_ms": 20, "result": {...}},
    {"name": "search", "duration_ms": 60, "result": {...}},
    {"name": "generate", "duration_ms": 2500, "result": {...}}
  ],
  "total_duration_ms": 2600,
  "confidence_score": 85,
  "cs_action": "approved"
}
```

---

## 확장성 고려사항

### 수평 확장 (Horizontal Scaling)

```
┌─────────────────┐
│  Load Balancer  │
└────────┬────────┘
         │
    ┌────┴────┬────────┬────────┐
    ↓         ↓        ↓        ↓
[FastAPI 1][FastAPI 2][FastAPI 3][FastAPI 4]
    │         │        │        │
    └────┬────┴────────┴────────┘
         ↓
  [Weaviate Cluster]
  [MongoDB Replica Set]
```

### 캐싱 전략

```
Redis 캐싱:
- 자주 조회되는 제품 스펙 (TTL: 1시간)
- 유사 FAQ 검색 결과 (TTL: 30분)
- 고객 정보 (TTL: 10분)

효과: API 응답 시간 50% 단축 (예상)
```

---

## 장애 복구 (Disaster Recovery)

### 백업 전략

```
MongoDB:
- 매일 자정 전체 백업
- 6시간마다 증분 백업
- 30일간 보관

Weaviate:
- 매일 벡터 스냅샷
- 필요 시 재생성 가능 (MongoDB 기반)
```

### 장애 시나리오

| 장애 | 복구 방법 | RTO* |
|------|-----------|------|
| FastAPI 다운 | 자동 재시작 | 1분 |
| Weaviate 다운 | 복제본 전환 | 5분 |
| MongoDB 다운 | Replica Set Failover | 30초 |
| 전체 장애 | 백업에서 복원 | 2시간 |

*RTO: Recovery Time Objective (목표 복구 시간)

---

다음 문서: [03. 기술 스택 - 질문 분석](./03_기술스택_질문분석.md)
