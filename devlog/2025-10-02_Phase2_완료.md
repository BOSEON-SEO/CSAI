# Phase 2 완료 - 데이터 준비 및 Weaviate 벡터 DB 구축

**작성일**: 2025-10-02 15:30  
**작성자**: Claude  
**Phase**: Phase 2 완료, Phase 3 진행 중 (20%)

---

## 📊 작업 요약

### 완료된 작업
- ✅ MongoDB FAQ 데이터 1,581건 임포트
- ✅ Weaviate 벡터 DB 스키마 생성 (FAQ, Product)
- ✅ Sentence-BERT 임베딩 1,581개 생성 및 업로드
- ✅ GPU 활용 최적화 (RTX 3050)

### 성과
- **임베딩 생성 시간**: 11.7초 (GPU 활용)
- **업로드 시간**: 17초
- **총 소요 시간**: 약 32초
- **실패**: 0건 (100% 성공률)

---

## 🛠️ 기술적 세부사항

### 1. MongoDB 데이터 임포트

**실행 명령어**:
```bash
cd C:\workspace\CSAI\backend\scripts
python import_data.py --type faqs --source ../../data/raw/naver_store_customer_inquiries.csv
```

**결과**:
- 1,581건 FAQ 데이터 임포트 완료
- `faqs` 컬렉션 생성
- 자동 인덱스 생성 (inquiry_no, brand_channel, category 등)

**데이터 구조**:
```json
{
  "_id": ObjectId("..."),
  "inquiry_no": 313605440,
  "brand_channel": "KEYCHRON",
  "inquiry_category": "반품",
  "title": "반품 가능 여부",
  "inquiry_content": "...",
  "answer_content": "...",
  "answered": true,
  "created_at": ISODate("2025-10-02T06:15:47.039Z"),
  "updated_at": ISODate("2025-10-02T06:15:47.039Z")
}
```

---

### 2. Weaviate 스키마 생성

**실행 명령어**:
```bash
python setup_weaviate.py
```

**생성된 클래스**:

#### FAQ 클래스
```python
Properties:
- faq_id (TEXT): FAQ 고유 ID
- inquiry_no (INT): 문의 번호
- mongodb_id (TEXT): MongoDB 문서 _id
- brand_channel (TEXT): 브랜드 (KEYCHRON, GTGEAR, AIPER)
- category (TEXT): 문의 카테고리
- combined_text (TEXT): 질문+답변 결합 텍스트
- answered (BOOL): 답변 완료 여부
- created_at (DATE): 생성 일시

Vector Index: 768차원 (Sentence-BERT)
```

#### Product 클래스
```python
Properties:
- product_id (TEXT): 제품 고유 ID
- mongodb_id (TEXT): MongoDB 문서 _id
- brand_channel (TEXT): 브랜드
- product_name (TEXT): 제품명
- combined_text (TEXT): 제품명+스펙 결합 텍스트
- discontinued (BOOL): 단종 여부

Vector Index: 768차원
```

---

### 3. 임베딩 생성 및 업로드

**실행 명령어**:
```bash
python import_to_weaviate.py --type faqs --brand KEYCHRON
```

**프로세스**:

#### Step 1: MongoDB → FAQ 로드
```
[1/4] MongoDB에서 FAQ 읽기...
  🏷️  브랜드 필터: KEYCHRON
  ✅ 1581개 FAQ 로드 완료
```

#### Step 2: 텍스트 결합
```
[2/4] FAQ 텍스트 준비 중...
  ✅ 1581개 텍스트 준비 완료
```

**텍스트 결합 로직**:
```python
combined_text = f"{title} {inquiry_content} {answer_content}"
```

#### Step 3: 임베딩 생성 (Sentence-BERT)
```
[3/4] 임베딩 생성 중...
  🔄 1581개 텍스트 임베딩 생성 중... (배치 크기: 100)
  💻 디바이스: cuda
  🎮 GPU: NVIDIA GeForce RTX 3050
  ✅ 1581개 임베딩 생성 완료 (11.7초)
```

**성능**:
- 배치 크기: 100
- GPU 활용: CUDA
- 처리 속도: 약 135개/초
- 벡터 차원: 768

#### Step 4: Weaviate 업로드
```
[4/4] Weaviate에 저장 중...
  → 100/1581 완료...
  → 200/1581 완료...
  ...
  → 1581/1581 완료...
```

**최종 결과**:
```
📊 임포트 결과
======================================================================
  ✅ 성공:  1581개
  ❌ 실패:     0개
======================================================================
```

---

## 🔍 트러블슈팅

### 이슈 1: Weaviate 클러스터 모드 에러

**증상**:
```
attempted to join and failed
remoteNode: 172.18.0.3:8300
```

**원인**:
- Weaviate가 클러스터 모드로 동작하려고 시도
- 환경 변수에 클러스터 설정 불필요하게 포함

**해결**:
1. `docker-compose.yml`에서 클러스터 관련 환경 변수 모두 제거
   ```yaml
   # 제거한 변수들:
   # CLUSTER_HOSTNAME
   # CLUSTER_GOSSIP_BIND_PORT
   # CLUSTER_DATA_BIND_PORT
   # RAFT_JOIN
   # RAFT_BOOTSTRAP_EXPECT
   ```

2. Docker 컨테이너 재시작
   ```bash
   docker-compose stop weaviate
   docker-compose rm -f weaviate
   docker volume rm docker_weaviate_data
   docker-compose up -d weaviate
   ```

3. 결과: Standalone 모드로 정상 작동

---

### 이슈 2: gRPC 포트 노출 누락

**증상**:
```
gRPC health check could not be completed
Port: localhost:50051
```

**원인**:
- `docker-compose.yml`에 gRPC 포트 매핑 누락

**해결**:
```yaml
weaviate:
  ports:
    - "8081:8080"  # HTTP API
    - "50051:50051"  # gRPC API (추가)
```

---

### 이슈 3: Weaviate Ready 지연

**증상**:
```
HTTP/1.1 503 Service Unavailable
Weaviate가 준비되지 않았습니다
```

**원인**:
- Weaviate 컨테이너는 올라왔지만 내부 초기화 진행 중
- 인덱스 초기화, 스키마 로딩 등에 시간 소요

**해결**:
1. `setup_weaviate.py`에 재시도 로직 추가
   ```python
   max_retries = 30
   for i in range(max_retries):
       if client.is_ready():
           break
       time.sleep(2)
   ```

2. 또는 컨테이너 시작 후 30초~1분 대기

---

## 📈 성능 분석

### GPU 활용 효과

| 작업 | CPU (예상) | GPU (실제) | 개선율 |
|------|------------|------------|--------|
| 임베딩 생성 (1,581개) | ~2분 | 11.7초 | **10배** ↑ |
| 배치 처리 속도 | ~20개/초 | 135개/초 | **6.7배** ↑ |

**GPU 스펙**:
- NVIDIA GeForce RTX 3050
- CUDA 12.6
- VRAM: 4GB

---

### Weaviate 저장 성능

| 메트릭 | 값 |
|--------|-----|
| 총 업로드 시간 | 17초 |
| 배치 크기 | 100개 |
| 처리 속도 | 약 93개/초 |
| 실패율 | 0% |

---

## 🎯 다음 단계

### Phase 3 진행 (20% → 100%)

#### 1주차: 벡터 검색 테스트 (진행 예정)
- [ ] Weaviate 하이브리드 검색 테스트
- [ ] 유사도 점수 threshold 설정
- [ ] QuestionAnalyzer 클래스 구현
  - Sentence-BERT + spaCy 통합
  - 질문 카테고리 분류
  - 복잡도 점수 계산

#### 2주차: 서비스 레이어 구현
- [ ] WeaviateService 클래스
- [ ] MongoDBService 클래스
- [ ] ConfidenceScorer 클래스

#### 3주차: Claude API 통합
- [ ] ClaudeService 클래스
- [ ] MCP 서버 구성
- [ ] 프롬프트 템플릿 작성

#### 4주차: FastAPI 엔드포인트
- [ ] /api/analyze
- [ ] /api/search
- [ ] /api/answer
- [ ] /api/review

---

## 💾 데이터 현황

### MongoDB Collections

```
csai_database
├─ faqs: 1,581 documents
│  ├─ KEYCHRON: 1,581건
│  └─ Indexes: 5개
└─ products: 0 documents (임포트 대기)
```

### Weaviate Classes

```
Weaviate (localhost:8081)
├─ FAQ: 1,581 vectors (768 dims)
│  ├─ Brand: KEYCHRON
│  └─ Created: 2025-10-02
└─ Product: 0 vectors
```

---

## 📝 학습 내용

### 1. Vector DB + NoSQL 조합의 중요성

**깨달음**:
- Weaviate는 "의미 검색"만 담당
- MongoDB는 "실제 데이터"를 저장
- 두 DB가 상호 보완적으로 작동

**작동 흐름**:
```
질문 → Weaviate 검색 → FAQ ID 획득
     → MongoDB 조회 → 실제 FAQ 내용 반환
     → Claude에게 전달
```

---

### 2. GPU 활용의 중요성

**임베딩 생성 속도**:
- CPU: 제한적 (병렬화 어려움)
- GPU: 대량 병렬 처리 가능
- **결과**: 10배 빠른 처리 속도

**권장 사항**:
- 프로덕션 환경에서도 GPU 서버 사용 권장
- AWS EC2 G4 인스턴스 또는 유사 옵션

---

### 3. Docker Compose 설정의 중요성

**배운 점**:
- 환경 변수 하나하나가 중요
- 불필요한 설정은 제거할 것
- 로그 확인의 중요성

**Best Practice**:
```yaml
# 필수 항목만 명시
# 기본값 활용
# 주석으로 이유 설명
```

---

## 🏆 성과 요약

### 정량적 성과
- **데이터**: 1,581건 FAQ 벡터화
- **성공률**: 100%
- **소요 시간**: 32초 (임베딩 + 업로드)
- **GPU 가속**: 10배 성능 향상

### 정성적 성과
- Docker 환경 트러블슈팅 경험
- Weaviate 운영 노하우 축적
- GPU 활용 최적화 방법 학습
- Vector DB + NoSQL 조합 이해

---

## 📚 참고 문서

### 프로젝트 문서
- `개발현황.md`: 전체 진행 상황
- `docs/04_기술스택_벡터DB.md`: Weaviate 상세 설명
- `docs/05_기술스택_NoSQL.md`: MongoDB 상세 설명

### 스크립트
- `backend/scripts/import_data.py`: MongoDB 임포트
- `backend/scripts/setup_weaviate.py`: Weaviate 스키마
- `backend/scripts/import_to_weaviate.py`: 임베딩 생성

---

## 🔖 태그

`#Phase2` `#완료` `#Weaviate` `#MongoDB` `#임베딩` `#GPU` `#Sentence-BERT` `#Docker`

---

**작성일**: 2025-10-02 15:30  
**작성자**: Claude  
**다음 devlog**: QuestionAnalyzer 구현 완료 시
